<VirtualHost *:<%= @params[:server_port] || node['apache']['listen_ports'].first %>>
ServerName https://<%= @params[:server_name] %>
UseCanonicalName On
<% if @params[:server_aliases] -%>
  ServerAlias <%= @params[:server_aliases].join " " %>
<% end -%>
DocumentRoot <%= @params[:docroot] %>

  <% if @params[:ssl] %>
  SSLEngine on
  SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP

  SSLCertificateFile      "<%= @params[:ssl][:cert_file] or '/etc/pki/tls/certs/localhost.crt' %>"
  SSLCertificateKeyFile   "<%= @params[:ssl][:cert_key_file] or '/etc/pki/tls/private/localhost.key' %>"
  SSLCACertificateFile    "<%= @params[:ssl][:ca_cert_file] or '/etc/pki/tls/certs/ca-bundle.crt' %>"
<% end %>

<Directory <%= @params[:docroot] %>>
  Options <%= [@params[:directory_options] || "FollowSymLinks" ].flatten.join " " %>
  AllowOverride <%= [@params[:allow_override] || "None" ].flatten.join " " %>
  <% if node['apache']['version'] == '2.4' -%>
    Require all granted
  <% else -%>
    Order allow,deny
    Allow from all
  <% end -%>
</Directory>

<Directory />
Options FollowSymLinks
AllowOverride None
</Directory>

<Location /server-status>
SetHandler server-status

<% if node['apache']['version'] == '2.4' -%>
  Require local
<% else -%>
  Order Deny,Allow
  Deny from all
  Allow from 127.0.0.1
<% end -%>

</Location>

LoadModule mod_shib /usr/lib64/shibboleth/mod_shib_22.so
<Location /Shibboleth.sso>
  Satisfy Any
  Allow from all
</Location>

<IfModule mod_alias.c>
  <Location /shibboleth-sp>
    Satisfy Any
    Allow from all
  </Location>
  Alias /shibboleth-sp/main.css /usr/share/shibboleth/main.css
  <Location /ds>
    Allow from all
    <IfModule mod_shib.c>
      AuthType shibboleth
      ShibRequestSetting requireSession false
      require shibboleth
    </IfModule>
  </Location>
  Alias /ds /var/www/ds
</IfModule>
<IfModule mod_shib>
  <Location /oauth2/authorize>
    AuthType shibboleth
    ShibRequireSession On
    ShibUseHeaders On
    require valid-user
  </Location>
</IfModule>

RewriteEngine On
<%- if node['apache']['version'] == '2.4' -%>
  LogLevel info rewrite:trace1
<%- else -%>
  LogLevel info
  RewriteLog <%= node['apache']['log_dir'] %>/<%= @application_name %>-rewrite.log
  RewriteLogLevel 0
<%- end -%>

ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-error.log
CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-access.log combined

<% if @params[:directory_index] -%>
  DirectoryIndex <%= [@params[:directory_index]].flatten.join " " %>
<% end -%>

# Canonical host, <%= @params[:server_name] %>
RewriteCond %{HTTP_HOST}   !^<%= @params[:server_name] %> [NC]
RewriteCond %{HTTP_HOST}   !^$
RewriteRule ^/(.*)$        http://<%= @params[:server_name] %>/$1 [L,R=301]

RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
RewriteCond %{SCRIPT_FILENAME} !maintenance.html
RewriteRule ^.*$ /system/maintenance.html [L]
</VirtualHost>